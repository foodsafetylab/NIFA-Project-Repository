---
title: "FIeld trials CA 2022_v1"
author: "JQP"
date: "2023-06-29"
output:
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r echo=F}
library(tidyverse)
library(MASS)
library(car)
```


```{r}
raw<-read.csv("Exp_1_results_organized.csv")
str(raw)
Fanoe<-read.csv("Experiment_1_trimmed.csv")
str(Fanoe)
Fanoe$Zone<-as.factor(Fanoe$Zone)
Fanoe$Top.bottom<-as.factor(Fanoe$Top.bottom)
Fanoe$Wet.dry<-as.factor(Fanoe$Wet.dry)
Fanoe$Hand.msd<-as.factor(Fanoe$Hand.msd)
Fanoe$Opportunity<-as.factor(Fanoe$Opportunity)
Fanoe$Sample.Type<-as.factor(Fanoe$Sample.Type)
Fanoe$Log.Coli.<-as.numeric(Fanoe$Log.Coli.)
str(Fanoe) #This contains all original and repeated samples, 
SumFanoe<-Fanoe%>%group_by(Sample.Type, Opportunity,Wet.dry, Hand.msd)%>%summarise(n=n())
knitr::kable(SumFanoe)
```
**Dataset containing all samples, all originals and all repeated. Originals that lacked information, were TNTC or odd results. Produce original= 22; Produce repeat= 14; Dry cloths msd Original= 11;Dry cloths msd repeated= 3; Wet cloths hand original=6;Wet cloths hand repeat=4; Wet cloths MSD original=15; Wet cloths MSD repeat=11**
*Initial Visuals*

```{r echo=FALSE}
APC_MTvPr<-ggplot(data= Fanoe, aes(x=Zone, y=Log.APC. , col= Sample.Type))+
  geom_boxplot(outlier.alpha = 0)+theme(plot.title = element_text(size = rel(1.2), face = "bold"), axis.text = element_text(size= 10, angle=0, hjust=0.5), axis.title = element_text(size=12))+
  expand_limits(y=0)+
  scale_y_continuous("Best Estimate APC (Log CFU/g)", breaks= c(1,2,3,4,5,6,7))+
  geom_point(position=position_jitterdodge(),alpha=1)+
  ggtitle("Overall PreHarvest Bacterial Recovery Comparison - Swab v Composite Tissue ")
APC_MTvPr+facet_grid(.~Opportunity)
```

```{r echo=FALSE}
Colif_MTvPr<-ggplot(data= Fanoe, aes(x=Zone, y=Log.Coli. , col= Sample.Type))+
  geom_boxplot(outlier.alpha = 0)+theme(plot.title = element_text(size = rel(1.2), face = "bold"), axis.text = element_text(size= 10, angle=0, hjust=0.5), axis.title = element_text(size=12))+
  expand_limits(y=0)+
  scale_y_continuous("Best Estimate Coliforms (Log CFU/g)", breaks= c(1,2,3,4,5,6,7))+
  geom_point(position=position_jitterdodge(),alpha=1)+
  ggtitle("Overall PreHarvest Bacterial Recovery Comparison - Swab v Composite Tissue ")
Colif_MTvPr+facet_grid(.~Opportunity)
```
*Overall, higher APC and Coliforms on repeated samples, why?* 

*_However, following discussion on 07/11/22, we kept the originals and filled in the gaps with the repeated samples_*

```{r}
adj_Fanoe<-read.csv("Experiment_1_adjusted trim.csv")
adj_Fanoe$Zone<-as.factor(adj_Fanoe$Zone)
adj_Fanoe$Top.bottom<-as.factor(adj_Fanoe$Top.bottom)
adj_Fanoe$Wet.dry<-as.factor(adj_Fanoe$Wet.dry)
adj_Fanoe$Hand.msd<-as.factor(adj_Fanoe$Hand.msd)
adj_Fanoe$Opportunity<-as.factor(adj_Fanoe$Opportunity)
adj_Fanoe$Sample.Type<-as.factor(adj_Fanoe$Sample.Type)
str(adj_Fanoe)
wkngsamples_Fanoe<-adj_Fanoe%>%group_by(Sample.Type, Wet.dry, Hand.msd, Zone)%>%summarise(n=n())
totalecoli<-adj_Fanoe%>%group_by(Sample.Type, Log.E.coli.)%>%summarise(count=n())
knitr::kable(wkngsamples_Fanoe)
knitr::kable(totalecoli)
```
**Updated working dataset consists on 32 swabs and 22 produce samples, N=54. MSD Dry cloths n=11, Prehydrated cloths, hand n=6, Prehydrated cloths, MSD n= 15.** **Generic *E. coli* Neg swabs= 26, Pos swabs= 6; Neg Produce= 13, Pos produce= 9**

*Graphs for overall visualization of all samples, based on field parameters and head collection*
```{r echo=FALSE}
OvPH_MTvTissue_APC<-ggplot(data= adj_Fanoe, aes(x=Sample.Type, y=Log.APC. , col= Sample.Type))+
  geom_boxplot(outlier.alpha = 0)+theme(plot.title = element_text(size = rel(1.2), face = "bold"), axis.text = element_text(size= 10, angle=0, hjust=0.5), axis.title = element_text(size=12))+
  expand_limits(y=0)+
  scale_y_continuous("Best Estimate APC (Log CFU/g)", breaks= c(1,2,3,4,5,6,7,8,9))+
  geom_point(position=position_jitterdodge(),alpha=1)+
  ggtitle("Overall PreHarvest APC Recovery Comparison - Aggregative Swab v Composite Produce Samples")
OvPH_MTvTissue_APC+facet_grid(Hand.msd~Wet.dry)

OvPH_MTvTissue_Colif<-ggplot(data= adj_Fanoe, aes(x=Sample.Type, y=Log.Coli. , col= Sample.Type))+
  geom_boxplot(outlier.alpha = 0)+theme(plot.title = element_text(size = rel(1.2), face = "bold"), axis.text = element_text(size= 10, angle=0, hjust=0.5), axis.title = element_text(size=12))+
  expand_limits(y=0)+
  scale_y_continuous("Best Estimate Coliforms (Log CFU/g)", breaks= c(1,2,3,4,5,6,7,8,9))+
  geom_point(position=position_jitterdodge(),alpha=1)+
  ggtitle("Overall PreHarvest Coliform Recovery Comparison - Aggregative Swab v Composite Produce Samples")
OvPH_MTvTissue_Colif+facet_grid(Hand.msd~Wet.dry)

Zone_OvPH_MTvTissue_APC<-ggplot(data= adj_Fanoe, aes(x=Zone, y=Log.APC. , col= Sample.Type))+
  geom_boxplot(outlier.alpha = 0)+theme(plot.title = element_text(size = rel(1.2), face = "bold"), axis.text = element_text(size= 10, angle=0, hjust=0.5), axis.title = element_text(size=12))+
  expand_limits(y=0)+
  scale_y_continuous("Best Estimate APC (Log CFU/g)", breaks= c(1,2,3,4,5,6,7,8,9))+
  geom_point(position=position_jitterdodge(),alpha=1)+
  ggtitle("Overall PreHarvest APC Recovery Comparison by Zone- Aggregative Swab v Composite Produce Samples")
Zone_OvPH_MTvTissue_APC+facet_grid(Hand.msd~Wet.dry)

Zone_OvPH_MTvTissue_Colif<-ggplot(data= adj_Fanoe, aes(x=Zone, y=Log.Coli. , col= Sample.Type))+
  geom_boxplot(outlier.alpha = 0)+theme(plot.title = element_text(size = rel(1.2), face = "bold"), axis.text = element_text(size= 10, angle=0, hjust=0.5), axis.title = element_text(size=12))+
  expand_limits(y=0)+
  scale_y_continuous("Best Estimate Coliforms (Log CFU/g)", breaks= c(1,2,3,4,5,6,7,8,9))+
  geom_point(position=position_jitterdodge(),alpha=1)+
  ggtitle("Overall PreHarvest Coliform Recovery Comparison by Zone- Aggregative Swab v Composite Produce Samples")
Zone_OvPH_MTvTissue_Colif+facet_grid(Hand.msd~Wet.dry)
```

##Cleaning for analysis 
###Analysis of Agg Swabs

```{r echo=F}
Only_Swabs<-adj_Fanoe%>%filter(Sample.Type=="Aggregative Swab")
Only_Swabs_noEcoli<-Only_Swabs[,-13] #This one would be replaced using a dataset that combines tests under a single column, rather than each test having its own column. This file was manually manipulated for this purpose, there is no code for it.
Only_Swabs_noEcoli1<-read.csv("LabPPT_AdjustedFanoe Exp_1.csv")
Only_Swabs_noEcoli<-Only_Swabs_noEcoli1%>% filter(Sample.Type=="Aggregative Swab")
Only_Swabs_noEcoli<-Only_Swabs_noEcoli%>% filter(Test != "E.coli")
#Once filtered
Only_Swabs_noEcoli$Sample.Type<-as.factor(Only_Swabs_noEcoli$Sample.Type)
Only_Swabs_noEcoli$Hand.msd<-as.factor(Only_Swabs_noEcoli$Hand.msd)
Only_Swabs_noEcoli$Wet.dry<-as.factor(Only_Swabs_noEcoli$Wet.dry)
Only_Swabs_noEcoli$Test<-as.factor(Only_Swabs_noEcoli$Test)
Only_Swabs_noEcoli$Zone<-as.factor(Only_Swabs_noEcoli$Zone)
Only_Swabs_noEcoli$Top.bottom<-as.factor(Only_Swabs_noEcoli$Top.bottom)
str(Only_Swabs_noEcoli)

Everything_but_Ecoli<-adj_Fanoe[,-13]
str(Everything_but_Ecoli)
```

####Visualization
```{r echo=FALSE}
OvPH_MT<-ggplot(data= Only_Swabs_noEcoli, aes(x=Hand.msd, y=Best..Estimate, col= Wet.dry))+
  geom_boxplot(outlier.alpha = 0, position = position_dodge2(preserve="single"))+
  geom_hline(yintercept = 0.7, color="steelblue")+
  #geom_hline(yintercept = 0.3, color="steelblue")+
  theme(plot.title = element_text(size = rel(1.2), face = "bold"), legend.position = "top", axis.text = element_text(size= 10, angle=0, hjust=0.5), 
  axis.title = element_text(size=12))+
  geom_point(position=position_jitterdodge(jitter.width = 0.05, jitter.height = 0.05))+
  #stat_compare_means(method = "anova", label.y = 40)+
  expand_limits(y=0)+
  scale_y_continuous("Bacterial Counts Estimate (Log CFU/g of swab)", breaks= c(1,2,3,4,5,6,7,8,9))+
  scale_x_discrete("Collection method (Pressure)", labels=c("by Hand", "Manual Sampling Device"))+
  scale_color_manual(values=c("#1B9E77", "#d95f02"), labels=c("Dry Cloth", "Prehydrated Cloth")) +
  #scale_color_discrete(labels=c("Dry Cloth", "Prehydrated Cloth"))+
  labs(col="Hydration Factor")+
  ggtitle("Pressure and Hydration Effects on Bacterial Recovery in Aggregative Swab Sampling Technique Optimization")

OvPH_MT+facet_grid(.~Test)
ggsave("Swab-characterization-overallUPDATE.jpeg", device = "jpeg", dpi=300, path = "C:/Users/jorge/Box Sync/NIFA Project/NIFA Project Repository/Output 2022", height= 5, width= 10, units = "in")
```

#Statistical Analysis - BASIC

```{r echo=F}
#Dataset used for this analysis remained unmanipulated manually ("data=Only_Swabs"). The manipulated manually is for visualization purposes (data= Only_Swabs_noEcoli")

#APC
##APC lm
lm_APC_2fac<-lm(Log.APC.~Wet.dry +Hand.msd+ Hand.msd:Wet.dry, data=Only_Swabs)
locAPClm<-lm(Log.APC.~ Wet.dry +Hand.msd+ Zone + Hand.msd:Wet.dry + Hand.msd:Zone +Wet.dry:Zone+ Hand.msd*Wet.dry*Zone, data=Only_Swabs)
plantAPClm<-lm(Log.APC. ~ Wet.dry +Hand.msd+ Top.bottom+ Hand.msd:Wet.dry + Hand.msd:Top.bottom +Wet.dry:Top.bottom+ Hand.msd*Wet.dry*Top.bottom, data=Only_Swabs)
###anova
APC_BothFactors<-anova(lm_APC_2fac)# Hydration matters most 3.008e-5
APC_Zone_Effect<-anova(locAPClm) #zones had no effect, hydration did
APC_InPlantLoc_effect<-anova(plantAPClm)#place in plant had no effect, hydration did

#Coliforms
##Coliforms lm
lm_Colif_2fac2<-lm(Log.Coli.~Wet.dry +Hand.msd+ Hand.msd:Wet.dry, data=Only_Swabs)
locColiflm<-lm(Log.Coli.~Wet.dry +Hand.msd+ Zone + Hand.msd:Wet.dry + Hand.msd:Zone +Wet.dry:Zone+ Hand.msd*Wet.dry*Zone, data=Only_Swabs)
plantColiflm<-lm(Log.Coli. ~ Wet.dry +Hand.msd+ Top.bottom+ Hand.msd:Wet.dry + Hand.msd:Top.bottom +Wet.dry:Top.bottom+ Hand.msd*Wet.dry*Top.bottom, data=Only_Swabs)
###ANOVA
Colif_BothFactors<-anova(lm_Colif_2fac2)#Both factors matter Hydration matters most 3.008e-5
Colif_Zone_Effect<-anova(locColiflm) #zones had no effect
Colif_InPlantLoc_effect<-anova(plantColiflm)#place in plant had no effect
```

#Summary ANOVA Tables for APC and Coliform counts
```{r}
knitr::kable(APC_BothFactors)
knitr::kable(APC_Zone_Effect)
knitr::kable(APC_InPlantLoc_effect)

knitr::kable(Colif_BothFactors)
knitr::kable(Colif_Zone_Effect)
knitr::kable(Colif_InPlantLoc_effect)
```

#Hydration drives the attachment of bacteria to the cloth, hence, this will be the sampling technique
##Clean  up dry swabs, keep the wet ones and compare them to produce
###Visualization
```{r echo=F}
#For analysis, we'll use data= "Everything_wet". For visualization, we'll use data= "Trimmed_W_data". 
Everything_wet<-Everything_but_Ecoli%>%filter(Sample.Type=="Produce Sample"|Sample.Type=="Aggregative Swab" & Wet.dry!="DRY")
WorkingDataset<-Everything_wet%>%group_by(Sample.Type)%>%summarise(count=n())
knitr::kable(WorkingDataset)

#visuals
Trimmed_W_data<-Only_Swabs_noEcoli1%>%filter(Sample.Type=="Produce Sample"|Sample.Type=="Aggregative Swab"&Wet.dry!="DRY")
Trimmed_W_data<-Trimmed_W_data%>% filter(Test != "E.coli")
Trimmed_W_data%>%group_by(Sample.Type, Wet.dry, Test)%>%summarise(count=n())
```

#Visuals 
```{r echo=FALSE}
OvPH_MTvPS<-ggplot(data= Trimmed_W_data, aes(x=Sample.Type, y=Best..Estimate, col=Sample.Type))+
  geom_boxplot(outlier.alpha = 0)+theme(plot.title = element_text(size = rel(1.2), face = "bold"), legend.position = "none", axis.text = element_text(size= 10, angle=0, hjust=0.5), axis.title = element_text(size=12))+
  geom_point(alpha=0.5)+
  expand_limits(y=0)+
  scale_color_manual(values=c("#1B9E77", "#7570B3")) +
  scale_y_continuous("Bacterial Counts Estimate (Log CFU/g)", breaks= c(1,2,3,4,5,6,7,8,9))+
  scale_x_discrete("Sample Type")+
  labs(fill= "Sample Type")+
  ggtitle("Bacterial Recovery in Aggregative Swab Cloths and Composite Produce Samples")
OvPH_MTvPS+facet_grid(.~ Test)
```
#Statistics
```{r echo=FALSE}
#APC
##Linear models
lmMTPS__APC<-lm(Log.APC.~Sample.Type, data=Everything_wet)
lmMTPS_locAPC<-lm(Log.APC.~ Sample.Type+ Zone + Sample.Type:Zone, data=Everything_wet)
lmMTPS_plantAPC<-lm(Log.APC. ~ Sample.Type+ Top.bottom + Sample.Type:Top.bottom, data=Everything_wet)
lmMTPS_APC_Overall<-lm(Log.APC.~ Sample.Type + Zone +Top.bottom + Sample.Type:Top.bottom + Sample.Type:Zone + Top.bottom:Zone + Sample.Type:Zone:Top.bottom, data=Everything_wet)

###ANOVA
MTPS_SamTypeAPC<-anova(lmMTPS__APC)
MTPS_locAPC<-anova(lmMTPS_locAPC)
MTPS_plantAPC<-anova(lmMTPS_plantAPC)
MTPS_APC_Overall<-anova(lmMTPS_APC_Overall)#Sample type is the only factor that matters
    
#Coliforms
##Linear models
lmMTPS__Colif<-lm(Log.Coli.~Sample.Type, data=Everything_wet)
lmMTPS_locColif<-lm(Log.Coli.~ Sample.Type+ Zone + Sample.Type:Zone, data=Everything_wet)
lmMTPS_plantColif<-lm(Log.Coli. ~ Sample.Type+ Top.bottom + Sample.Type:Top.bottom, data=Everything_wet)
lmMTPS_Colif_Overall<-lm(Log.Coli.~ Sample.Type + Zone +Top.bottom + Sample.Type:Top.bottom + Sample.Type:Zone + Top.bottom:Zone + Sample.Type:Zone:Top.bottom, data=Everything_wet)

MTPS_SamTypeColif<-anova(lmMTPS__Colif)
MTPS_locColif<-anova(lmMTPS_locColif)
MTPS_plantColif<-anova(lmMTPS_plantColif)
MTPS_Colif_Overall<-anova(lmMTPS_Colif_Overall)#Sample type is the only factor that matters
```


```{r}
knitr::kable(MTPS_SamTypeAPC)
knitr::kable(MTPS_locAPC)
knitr::kable(MTPS_plantAPC)
knitr::kable(MTPS_APC_Overall)

knitr::kable(MTPS_SamTypeColif)
knitr::kable(MTPS_locColif)
knitr::kable(MTPS_plantColif)
knitr::kable(MTPS_Colif_Overall)
```


#Appendix
```{r}

```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
